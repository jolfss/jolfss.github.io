/**
 * .rem-height-ceil-js
 *
 * This script runs on DOM ready and again when images load or window resizes.
 * It finds all elements with the class 'rem-height-ceil-js', calculates their actual content
 * height, and then adjusts the container's height to be the nearest multiple of 2rem.
 *
 * Requires:
 * - The container does not contain any elements that are themselves rem-height-ceil-js.
 *   (Or really *any* other dynamically resizing elements.)
 *
 * NOTE: This script was originally generated by Google Gemini and has been modified.
 */

// Cache the rem value to avoid repeated calculations
let remInPixels = null;

// Calculate and cache the rem value
const getRemInPixels = () => {
    if (remInPixels === null) {
        remInPixels = parseFloat(getComputedStyle(document.documentElement).fontSize);
        if (isNaN(remInPixels) || remInPixels <= 0) {
            console.error("Could not determine the pixel value of 1rem. Aborting script.");
            return null;
        }
    }
    return remInPixels;
};

// Resize a specific container
const resizeContainer = (container) => {
    try {
        const rem = getRemInPixels();
        if (rem === null) return;

        // Temporarily reset height to auto to measure the natural content height accurately.
        container.style.height = 'auto';

        // Get the total height of the content within the box.
        const contentHeight = container.scrollHeight;

        // Calculate the new height ceiled to the nearest multiple of (2 * 1rem).
        const stepHeight = 2 * rem;
        const newHeightInPixels = Math.ceil(contentHeight / stepHeight) * stepHeight;

        // Apply the new height to the container.
        container.style.height = `${newHeightInPixels}px`;

    } catch (error) {
        console.error("An error occurred while resizing container:", error);
    }
};

// Resize all containers
const resizeContainers = () => {
    try {
        // Select all the containers that need their height adjusted.
        const containers = document.querySelectorAll('.rem-height-ceil-js');

        if (containers.length === 0) {
            console.log("Resizable container script ran, but no elements with the class '.rem-height-ceil-js' were found.");
            return;
        }

        // Iterate over each container and adjust its height.
        containers.forEach(resizeContainer);

    } catch (error) {
        console.error("An error occurred during the rem resize container script:", error);
    }
};

// Set up image load listeners for a container
const attachImageLoadListeners = (container) => {
    const images = container.querySelectorAll('img');
    images.forEach(img => {
        // Only attach listener if image hasn't loaded yet
        if (!img.complete) {
            img.addEventListener('load', () => {
                resizeContainer(container);
            }, { once: true });

            // Also handle error case to prevent hanging
            img.addEventListener('error', () => {
                resizeContainer(container);
            }, { once: true });
        }
    });
};

// Initialize all containers
const initializeContainers = () => {
    const containers = document.querySelectorAll('.rem-height-ceil-js');
    containers.forEach(container => {
        resizeContainer(container);
        attachImageLoadListeners(container);
    });
};

// --- Event Listeners ---

// 1. Run the script once the DOM is ready (doesn't wait for images).
document.addEventListener('DOMContentLoaded', initializeContainers);

// 2. Rerun the script when the window is resized (with debouncing).
let resizeTimer;

window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(resizeContainers, 50);
});
